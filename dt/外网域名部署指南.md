# 🌐 中晋数据科技 - 外网域名部署指南

## 📋 目录

- [快速开始](#快速开始)
- [域名配置](#域名配置)
- [SSL证书配置](#ssl证书配置)
- [部署方式](#部署方式)
- [访问测试](#访问测试)
- [故障排除](#故障排除)
- [安全配置](#安全配置)

---

## 🚀 快速开始

### 域名信息
- **外网域名**: `dt.yongli.wang`
- **访问地址**: `https://dt.yongli.wang`
- **本地测试**: `http://localhost`

### 一键部署

```bash
# 克隆项目
git clone https://github.com/wkdays/datarecover.git
cd datarecover

# 外网域名部署
./deploy-domain.sh manual
```

### Docker Compose部署

```bash
# 使用Compose部署
./deploy-domain.sh compose
```

---

## 🌍 域名配置

### 1. DNS解析配置

确保域名 `dt.yongli.wang` 已正确解析到服务器IP：

```bash
# 检查域名解析
nslookup dt.yongli.wang
dig dt.yongli.wang

# 或使用在线工具
# https://www.whatsmydns.net/
```

### 2. 服务器要求

- **操作系统**: Linux (Ubuntu/CentOS/Debian)
- **Docker**: 20.10+
- **Docker Compose**: 1.29+
- **端口**: 80, 443 (开放防火墙)

### 3. 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 80
sudo ufw allow 443
sudo ufw reload

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

---

## 🔒 SSL证书配置

### 方式一：自签名证书（测试用）

```bash
# 生成自签名证书
./ssl-setup.sh self

# 或手动生成
mkdir -p proxy/ssl
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout proxy/ssl/key.pem \
    -out proxy/ssl/cert.pem \
    -subj "/C=CN/ST=Shanghai/L=Shanghai/O=中晋数据科技/CN=dt.yongli.wang"
```

### 方式二：Let's Encrypt证书（推荐）

```bash
# 安装Certbot
sudo apt-get install certbot  # Ubuntu/Debian
sudo yum install certbot     # CentOS/RHEL

# 生成Let's Encrypt证书
./ssl-setup.sh letsencrypt
```

### 方式三：购买商业证书

1. 购买SSL证书
2. 将证书文件放置到 `proxy/ssl/` 目录
3. 重命名为 `cert.pem` 和 `key.pem`

---

## 🐳 部署方式

### 方式一：手动部署（推荐）

```bash
# 完整部署流程
./deploy-domain.sh manual
```

**执行步骤**:
1. ✅ 检查Docker环境
2. ✅ 保护现有镜像
3. ✅ 配置SSL证书
4. ✅ 构建网站镜像
5. ✅ 启动网站服务
6. ✅ 启动反向代理
7. ✅ 健康检查

### 方式二：Docker Compose部署

```bash
# 使用Compose部署
./deploy-domain.sh compose
```

**配置文件**: `docker-compose.yml`

### 方式三：分步部署

```bash
# 仅配置SSL
./deploy-domain.sh ssl

# 查看服务状态
./deploy-domain.sh status

# 查看日志
./deploy-domain.sh logs
```

---

## 🔍 访问测试

### 1. 本地测试

```bash
# 测试网站服务
curl http://localhost:8080

# 测试代理服务
curl http://localhost

# 测试HTTPS
curl -k https://localhost
```

### 2. 外网测试

```bash
# 测试域名解析
curl https://dt.yongli.wang

# 测试HTTP重定向
curl -I http://dt.yongli.wang
# 应该返回 301 重定向到 HTTPS
```

### 3. 浏览器测试

1. 打开浏览器
2. 访问 `https://dt.yongli.wang`
3. 检查SSL证书状态
4. 测试网站功能

---

## 🛠️ 故障排除

### 常见问题

#### 1. 域名无法访问

```bash
# 检查DNS解析
nslookup dt.yongli.wang

# 检查服务器连通性
ping dt.yongli.wang

# 检查端口开放
telnet dt.yongli.wang 80
telnet dt.yongli.wang 443
```

#### 2. SSL证书问题

```bash
# 检查证书文件
ls -la proxy/ssl/

# 验证证书
openssl x509 -in proxy/ssl/cert.pem -text -noout

# 检查证书和私钥匹配
openssl x509 -noout -modulus -in proxy/ssl/cert.pem | openssl md5
openssl rsa -noout -modulus -in proxy/ssl/key.pem | openssl md5
```

#### 3. 容器启动失败

```bash
# 查看容器日志
docker logs zhongjin-datarecover
docker logs datarecover-proxy

# 检查容器状态
docker ps -a

# 重启服务
./deploy-domain.sh restart
```

#### 4. 端口冲突

```bash
# 检查端口占用
netstat -tulpn | grep -E ":80|:443"

# 停止冲突服务
sudo systemctl stop apache2  # 如果Apache占用80端口
sudo systemctl stop nginx    # 如果Nginx占用80端口
```

### 调试命令

```bash
# 进入容器调试
docker exec -it zhongjin-datarecover sh
docker exec -it datarecover-proxy sh

# 检查Nginx配置
docker exec datarecover-proxy nginx -t

# 重新加载Nginx配置
docker exec datarecover-proxy nginx -s reload
```

---

## 🔐 安全配置

### 1. 防火墙配置

```bash
# 只开放必要端口
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 2. SSL安全配置

```nginx
# nginx.conf 中已配置的安全头
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
```

### 3. 容器安全

```bash
# 使用非root用户运行
USER nginx

# 限制容器资源
docker run --memory=512m --cpus=1.0 ...
```

---

## 📊 监控与维护

### 1. 服务监控

```bash
# 查看服务状态
./deploy-domain.sh status

# 查看实时日志
./deploy-domain.sh logs

# 监控资源使用
docker stats
```

### 2. 日志管理

```bash
# 查看网站日志
docker logs -f zhongjin-datarecover

# 查看代理日志
docker logs -f datarecover-proxy

# 清理旧日志
docker system prune -f
```

### 3. 证书更新

```bash
# Let's Encrypt证书自动续期
sudo crontab -e
# 添加: 0 2 * * * /path/to/ssl-setup.sh letsencrypt

# 手动更新证书
./ssl-setup.sh letsencrypt
docker restart datarecover-proxy
```

---

## 🚀 生产环境优化

### 1. 性能优化

```yaml
# docker-compose.yml 中添加资源限制
services:
  datarecover-web:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

### 2. 负载均衡

```bash
# 多实例部署
docker-compose up -d --scale datarecover-web=3
```

### 3. 高可用配置

```bash
# 使用Docker Swarm
docker swarm init
docker stack deploy -c docker-compose.yml datarecover
```

---

## 📝 部署脚本使用

### 可用命令

```bash
./deploy-domain.sh [选项]
```

| 命令 | 功能 | 说明 |
|------|------|------|
| `manual` | 手动部署 | 逐步执行部署（默认） |
| `compose` | Compose部署 | 使用docker-compose |
| `ssl` | SSL配置 | 仅配置SSL证书 |
| `stop` | 停止服务 | 停止所有服务 |
| `restart` | 重启服务 | 重启所有服务 |
| `logs` | 查看日志 | 查看所有日志 |
| `status` | 查看状态 | 查看服务状态 |
| `clean` | 清理资源 | 删除所有资源 |
| `help` | 帮助信息 | 显示使用说明 |

### 使用示例

```bash
# 完整部署
./deploy-domain.sh manual

# 使用Compose部署
./deploy-domain.sh compose

# 仅配置SSL
./deploy-domain.sh ssl

# 查看服务状态
./deploy-domain.sh status

# 查看实时日志
./deploy-domain.sh logs

# 重启服务
./deploy-domain.sh restart

# 清理资源
./deploy-domain.sh clean
```

---

## 🌐 访问地址

### 部署成功后访问：

- **外网访问**: https://dt.yongli.wang
- **本地访问**: http://localhost
- **直接访问**: http://localhost:8080
- **健康检查**: https://dt.yongli.wang/health

### 管理地址：

- **容器管理**: `docker ps`
- **日志查看**: `./deploy-domain.sh logs`
- **状态检查**: `./deploy-domain.sh status`

---

## 📞 技术支持

### 联系方式

- 📧 邮箱: service@zhongjindata.com
- 📞 热线: 400-668-7788
- 🌐 官网: https://wkdays.github.io/datarecover/

### 问题反馈

1. 检查域名解析: `nslookup dt.yongli.wang`
2. 检查服务状态: `./deploy-domain.sh status`
3. 查看错误日志: `./deploy-domain.sh logs`
4. 重启服务: `./deploy-domain.sh restart`
5. 联系技术支持

---

## 📚 相关文档

- [Docker部署指南.md](./Docker部署指南.md) - Docker容器化部署
- [使用指南.md](./使用指南.md) - 网站使用说明
- [闭环流程说明.md](./闭环流程说明.md) - 技术流程文档
- [导航功能说明.md](./导航功能说明.md) - 导航技术分析
- [项目总结.md](./项目总结.md) - 完整项目总结

---

## 🎯 部署检查清单

### 部署前检查

- [ ] 域名 `dt.yongli.wang` 已解析到服务器IP
- [ ] 服务器防火墙已开放80/443端口
- [ ] Docker和Docker Compose已安装
- [ ] 服务器有足够资源（1GB内存，1核CPU）

### 部署后检查

- [ ] 网站可以正常访问 https://dt.yongli.wang
- [ ] SSL证书显示正常（绿色锁图标）
- [ ] 所有功能正常工作
- [ ] 日志无错误信息

### 安全检查

- [ ] 使用HTTPS访问
- [ ] SSL证书有效
- [ ] 防火墙配置正确
- [ ] 容器以非root用户运行

---

**🎉 恭喜！您的外网域名部署已完成！**

**访问地址**: https://dt.yongli.wang  
**管理命令**: `./deploy-domain.sh help`

---

© 2024 中晋数据科技有限公司


